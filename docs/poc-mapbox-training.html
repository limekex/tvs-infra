<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Virtual Training with Mapbox - POC</title>
  
  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  
  <!-- GSAP -->
  <script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: white;
      overflow: hidden;
    }

    #app {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    /* Welcome Screen */
    #welcome {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    #welcome.hidden {
      display: none;
    }

    .welcome-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 40px;
      max-width: 500px;
      text-align: center;
    }

    .welcome-card h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .welcome-card p {
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 30px;
      font-size: 1rem;
    }

    .route-info {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      text-align: left;
    }

    .route-info h2 {
      font-size: 1.2rem;
      margin-bottom: 15px;
      color: #4ade80;
    }

    .route-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 0.9rem;
    }

    .route-meta div {
      color: rgba(255, 255, 255, 0.6);
    }

    .route-meta strong {
      color: white;
      display: block;
      margin-top: 3px;
    }

    .speed-input-group {
      margin-bottom: 20px;
    }

    .speed-input-group label {
      display: block;
      margin-bottom: 10px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9rem;
    }

    #speedInput {
      width: 120px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      font-size: 1.5rem;
      text-align: center;
      font-weight: bold;
    }

    #speedInput:focus {
      outline: none;
      border-color: #4ade80;
    }

    #startBtn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 40px;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    #startBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
    }

    #startBtn:active {
      transform: translateY(0);
    }

    /* Map Container */
    #map {
      width: 100%;
      height: 100%;
    }

    /* Info Overlay */
    #info {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      min-width: 280px;
      z-index: 10;
    }

    #info h2 {
      font-size: 1.2rem;
      margin-bottom: 15px;
      color: #4ade80;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }

    .stat-label {
      color: rgba(255, 255, 255, 0.6);
    }

    .stat-value {
      color: white;
      font-weight: 600;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      margin: 15px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.1s linear;
    }

    /* Controls */
    #controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 10;
    }

    .control-btn {
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #4ade80;
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    /* Speed Controls */
    #info .speed-controls {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    #info .zoom-controls {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #info .zoom-btns {
      display: flex;
      gap: 5px;
    }

    #info .zoom-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }

    #info .zoom-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: #4ade80;
    }

    #info input[type="number"] {
      width: 80px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: white;
      font-size: 16px;
      text-align: center;
    }

    /* Loading State */
    #loading {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.9);
      z-index: 999;
    }

    #loading.hidden {
      display: none;
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mapbox Marker */
    .mapbox-marker {
      background: #ef4444;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.8);
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Loading State -->
    <div id="loading">
      <div class="spinner"></div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcome">
      <div class="welcome-card">
        <h1>üèÉ‚Äç‚ôÇÔ∏è Virtual Training</h1>
        <p>Experience real routes from a bird's eye view</p>
        
        <div class="route-info">
          <h2 id="routeTitle">Loading route...</h2>
          <div class="route-meta">
            <div>Distance: <strong id="routeDistance">‚Äî</strong></div>
            <div>Elevation: <strong id="routeElevation">‚Äî</strong></div>
            <div>Location: <strong id="routeLocation">‚Äî</strong></div>
            <div>Surface: <strong id="routeSurface">‚Äî</strong></div>
          </div>
        </div>

        <div class="speed-input-group">
          <label for="speedInput">Your Speed (km/h)</label>
          <input type="number" id="speedInput" value="12" min="1" max="50" step="0.5">
        </div>

        <button id="startBtn">Start Training</button>
      </div>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Info Overlay -->
    <div id="info" style="display: none;">
      <h2>Training Stats</h2>
      <div class="stat-row">
        <span class="stat-label">Distance:</span>
        <span class="stat-value" id="statDistance">0.0 / 8.2 km</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Time Elapsed:</span>
        <span class="stat-value" id="statTimeElapsed">0:00</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Time Remaining:</span>
        <span class="stat-value" id="statTimeRemaining">41:00</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Elevation:</span>
        <span class="stat-value" id="statElevation">0 m</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Progress:</span>
        <span class="stat-value" id="statProgress">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressBar"></div>
      </div>

      <div class="speed-controls">
        <div class="stat-row">
          <span class="stat-label">Speed:</span>
          <input type="number" id="speedAdjust" value="12" min="1" max="50" step="0.5" onchange="adjustSpeed()">
        </div>
      </div>
      <div class="zoom-controls">
        <span class="stat-label">Map Zoom:</span>
        <div class="zoom-btns">
          <button class="zoom-btn" onclick="adjustMapZoom(-1)">‚àí</button>
          <button class="zoom-btn" onclick="adjustMapZoom(1)">+</button>
        </div>
        <span class="stat-value" id="zoomLevel">15</span>
      </div>
      <div class="zoom-controls">
        <span class="stat-label">Follow:</span>
        <button class="zoom-btn" onclick="toggleFollow()" id="followBtn">‚úì On</button>
      </div>
    </div>

    <!-- Controls -->
    <div id="controls" style="display: none;">
      <button class="control-btn" onclick="togglePause()">‚è∏ Pause</button>
      <button class="control-btn" onclick="restartTraining()">‚Üª Restart</button>
      <button class="control-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
    </div>
  </div>

  <script>
    // Configuration
    const ROUTE_ID = 149; // Test route with GPX
    const API_BASE = 'http://localhost:8080/wp-json/tvs/v1';
    // NOTE: If you get 401 errors, create a new token at https://account.mapbox.com/access-tokens/
    // This token might be expired or restricted
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiYmV0YWl0IiwiYSI6ImNsaGhmZ3ZueTA4NHIzZW56a2VzNGoyY3EifQ.keiHwAPuzVVWMujunhJ6Fw';

    // State
    let map = null;
    let marker = null;
    let routeData = null;
    let routeInfo = null;
    let isPaused = false;
    let startTime = null;
    let pausedTime = 0;
    let currentSpeed = 12;
    let animationFrameId = null;
    let followMode = true; // Camera follows marker

    // Initialize
    mapboxgl.accessToken = MAPBOX_TOKEN;

    async function init() {
      try {
        // Fetch route info
        const infoResp = await fetch(`${API_BASE}/routes/${ROUTE_ID}`);
        routeInfo = await infoResp.json();
        
        // Fetch GPX data
        const gpxResp = await fetch(`${API_BASE}/routes/${ROUTE_ID}/gpx-data`);
        routeData = await gpxResp.json();

        // Update welcome screen
        document.getElementById('routeTitle').textContent = routeInfo.title;
        document.getElementById('routeDistance').textContent = routeData.distance_km + ' km';
        document.getElementById('routeElevation').textContent = 
          (routeData.elevation.max - routeData.elevation.min).toFixed(0) + ' m';
        document.getElementById('routeLocation').textContent = routeInfo.meta.location || 'Unknown';
        document.getElementById('routeSurface').textContent = routeInfo.meta.surface || 'Mixed';

        // Hide loading
        document.getElementById('loading').classList.add('hidden');

        console.log('‚úÖ Route loaded:', routeInfo.title);
        console.log('üìç Points:', routeData.point_count, '‚Üí', routeData.simplified_count);
        console.log('üìè Distance:', routeData.distance_km, 'km');
        console.log('üìà Elevation:', routeData.elevation.min, '-', routeData.elevation.max, 'm');
      } catch (error) {
        console.error('Failed to load route:', error);
        alert('Failed to load route data. Please check console.');
      }
    }

    function startTraining() {
      currentSpeed = parseFloat(document.getElementById('speedInput').value);
      document.getElementById('speedAdjust').value = currentSpeed;

      // Hide welcome, show map
      document.getElementById('welcome').classList.add('hidden');
      document.getElementById('info').style.display = 'block';
      document.getElementById('controls').style.display = 'flex';

      // Initialize map
      initMap();
    }

    function initMap() {
      const center = routeData.bounds.center;
      
      // Create map
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-streets-v12',
        center: center,
        zoom: 14,
        pitch: 60,
        bearing: 0
      });

      map.on('load', () => {
        // Add route line
        map.addSource('route', {
          type: 'geojson',
          data: {
            type: 'Feature',
            geometry: {
              type: 'LineString',
              coordinates: routeData.points.map(p => [p.lng, p.lat])
            }
          }
        });

        map.addLayer({
          id: 'route',
          type: 'line',
          source: 'route',
          paint: {
            'line-color': '#3b82f6',
            'line-width': 4,
            'line-opacity': 0.8
          }
        });

        // Add start marker
        const startMarker = document.createElement('div');
        startMarker.className = 'mapbox-marker';
        startMarker.style.background = '#4ade80';
        
        new mapboxgl.Marker(startMarker)
          .setLngLat([routeData.points[0].lng, routeData.points[0].lat])
          .addTo(map);

        // Add animated marker
        const markerEl = document.createElement('div');
        markerEl.className = 'mapbox-marker';
        
        marker = new mapboxgl.Marker(markerEl)
          .setLngLat([routeData.points[0].lng, routeData.points[0].lat])
          .addTo(map);

        // Start animation
        startAnimation();
      });
    }

    function startAnimation() {
      startTime = Date.now();
      pausedTime = 0;
      isPaused = false;
      animate();
    }

    function animate() {
      if (isPaused) return;

      const elapsed = (Date.now() - startTime - pausedTime) / 1000; // seconds
      const duration = (routeData.distance_km / currentSpeed) * 3600; // seconds
      const progress = Math.min(elapsed / duration, 1);

      // Smooth interpolation between points
      const exactIndex = progress * (routeData.points.length - 1);
      const pointIndex = Math.floor(exactIndex);
      const nextIndex = Math.min(pointIndex + 1, routeData.points.length - 1);
      const fraction = exactIndex - pointIndex;
      
      const point = routeData.points[pointIndex];
      const nextPoint = routeData.points[nextIndex];
      
      if (marker && point && nextPoint) {
        // Interpolate position between two points
        const lng = point.lng + (nextPoint.lng - point.lng) * fraction;
        const lat = point.lat + (nextPoint.lat - point.lat) * fraction;
        const ele = point.ele && nextPoint.ele 
          ? point.ele + (nextPoint.ele - point.ele) * fraction 
          : point.ele;
        
        marker.setLngLat([lng, lat]);
        
        // Continuous camera following (marker always centered)
        if (followMode) {
          map.jumpTo({
            center: [lng, lat]
          });
        }

        // Update stats with interpolated values
        updateStats(progress, duration, elapsed, { lat, lng, ele });
      }

      if (progress < 1) {
        animationFrameId = requestAnimationFrame(animate);
      } else {
        console.log('‚úÖ Training complete!');
      }
    }

    function updateStats(progress, totalDuration, elapsed, point) {
      const distanceTraveled = routeData.distance_km * progress;
      const distanceRemaining = routeData.distance_km - distanceTraveled;
      const timeRemaining = totalDuration - elapsed;

      document.getElementById('statDistance').textContent = 
        `${distanceTraveled.toFixed(2)} / ${routeData.distance_km} km`;
      document.getElementById('statTimeElapsed').textContent = formatTime(elapsed);
      document.getElementById('statTimeRemaining').textContent = formatTime(timeRemaining);
      document.getElementById('statProgress').textContent = (progress * 100).toFixed(1) + '%';
      document.getElementById('progressBar').style.width = (progress * 100) + '%';

      if (point && point.ele) {
        document.getElementById('statElevation').textContent = point.ele.toFixed(0) + ' m';
      }
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function togglePause() {
      isPaused = !isPaused;
      const btn = event.target;
      
      if (isPaused) {
        pausedTime += Date.now() - startTime;
        btn.textContent = '‚ñ∂ Resume';
      } else {
        startTime = Date.now();
        btn.textContent = '‚è∏ Pause';
        animate();
      }
    }

    function restartTraining() {
      cancelAnimationFrame(animationFrameId);
      if (marker) marker.setLngLat([routeData.points[0].lng, routeData.points[0].lat]);
      startAnimation();
    }

    function adjustSpeed() {
      const newSpeed = parseFloat(document.getElementById('speedAdjust').value);
      if (newSpeed > 0 && newSpeed <= 50) {
        currentSpeed = newSpeed;
        console.log('Speed adjusted to', currentSpeed, 'km/h');
      }
    }

    function adjustMapZoom(delta) {
      if (map) {
        const currentZoom = map.getZoom();
        const newZoom = Math.max(10, Math.min(18, currentZoom + delta));
        map.setZoom(newZoom);
        document.getElementById('zoomLevel').textContent = Math.round(newZoom);
      }
    }

    function toggleFollow() {
      followMode = !followMode;
      const btn = document.getElementById('followBtn');
      if (followMode) {
        btn.textContent = '‚úì On';
        btn.style.background = 'rgba(74, 222, 128, 0.3)';
        btn.style.borderColor = '#4ade80';
        console.log('üì∏ Camera follow: ON');
      } else {
        btn.textContent = '‚úó Off';
        btn.style.background = 'rgba(255, 255, 255, 0.1)';
        btn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
        console.log('üì∏ Camera follow: OFF - Pan/zoom freely!');
      }
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        togglePause();
      } else if (e.code === 'KeyF') {
        toggleFullscreen();
      } else if (e.code === 'KeyR') {
        restartTraining();
      }
    });

    // Event listeners
    document.getElementById('startBtn').addEventListener('click', startTraining);

    // Initialize on load
    init();

    console.log('üèÉ‚Äç‚ôÇÔ∏è Virtual Training POC with Mapbox');
    console.log('üìù Loading route data from REST API...');
  </script>
</body>
</html>
